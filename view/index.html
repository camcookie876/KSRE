<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Camcookie — MINI/view</title>
  <meta name="color-scheme" content="light only" />
  <meta id="meta-theme" name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg:#f7f7f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
      --accent:#0ea5e9; --accent-2:#22c55e; --danger:#ef4444;
      --warn-bg:#fff8e6; --warn-border:#f59e0b; --border:#e5e7eb;
      --shadow:0 10px 24px rgba(0,0,0,.06); --overlay: rgba(0,0,0,.62);
    }
    [data-theme="blue"]  { --bg:#f7f7f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#0ea5e9; --accent-2:#22c55e; }
    [data-theme="green"] { --bg:#eefbf4; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#22c55e; --accent-2:#16a34a; }
    [data-theme="pink"]  { --bg:#fff1f5; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#ec4899; --accent-2:#f472b6; }
    [data-theme="sunset"]{ --bg:#fff7ed; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#fb923c; --accent-2:#facc15; }
    [data-theme="slate"] { --bg:#f1f5f9; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#64748b; --accent-2:#94a3b8; }
    [data-theme="cyber"] { --bg:#0f172a; --card:#1e293b; --text:#f1f5f9; --muted:#94a3b8; --accent:#38bdf8; --accent-2:#22d3ee; --overlay: rgba(0,8,20,.74); }

    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; }
    .wrap{ max-width:1100px; margin:26px auto 100px; padding:0 16px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    h1{ font-size:1.2rem; margin:0; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:.5em .75em; border-radius:999px; font-weight:600; background:#eef2f7; color:#0f172a; border:1px solid #d7dde6; }
    .badge.warn{ background:var(--warn-bg); border-color:var(--warn-border); }
    .muted{ color:var(--muted); }
    .btn{ border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; letter-spacing:.2px; background:var(--accent); color:#fff; transition:transform .1s ease, opacity .2s ease; }
    .btn:active{ transform:translateY(1px); }
    .btn.secondary{ background:#e5e7eb; color:#111827; }
    .btn.ghost{ background:transparent; color:#111827; border:1px solid var(--border); }
    [data-theme="cyber"] .btn.ghost{ color:#f1f5f9; border-color:#263347; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:14px; margin-top:14px; }
    .card{ background:var(--card); border-radius:12px; padding:14px; border:1px solid rgba(0,0,0,.06); box-shadow:var(--shadow); display:flex; flex-direction:column; gap:10px; }
    .title{ font-weight:800; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pin{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:1.05rem; background:#f3f4f6; padding:6px 10px; border-radius:8px; display:inline-flex; align-items:center; gap:8px; }
    .small{ font-size:.92rem; }
    .notice{ margin:12px 0; padding:12px; border-radius:12px; border:1px dashed var(--warn-border); background:#fffaf0; color:#92400e; }
    .expired{ border:1px solid #fecaca; background:#fff1f2; color:#991b1b; }
    .divider{ height:1px; background:var(--border); margin:12px 0; }
    .footer{ margin-top:18px; color:var(--muted); font-size:.92rem; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }

    /* Scanner */
    .scanWrap{ background:var(--card); border-radius:12px; border:1px solid rgba(0,0,0,.06); box-shadow:var(--shadow); padding:14px; }
    .scanBox{ width:100%; max-width:560px; margin:12px auto; display:flex; flex-direction:column; gap:10px; }
    video#cam{ width:100%; max-height:56vh; background:#000; border-radius:12px; }
    canvas#stage{ display:none; }
    .hint{ color:var(--muted); }

    /* Theme popup */
    #themeModal{ position:fixed; inset:0; display:none; z-index:120; }
    #themeModal.show{ display:block; }
    #themeModal .bg{ position:absolute; inset:0; background:rgba(0,0,0,.55); }
    #themeModal .panel{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:min(480px,92vw); background:var(--card); color:var(--text); border-radius:16px; box-shadow:0 30px 80px rgba(0,0,0,.28); border:1px solid rgba(0,0,0,.08); padding:16px; }
    #themeModal .head{ display:flex; align-items:center; gap:8px; margin-bottom:10px; }
    #themeModal .head h2{ margin:0; font-size:1.1rem; }
    #themeModal .close{ margin-left:auto; background:transparent; border:0; cursor:pointer; padding:6px; border-radius:8px; }
    #themeSelect{ width:100%; padding:12px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(180deg,#fff,#f7f7f7); font-weight:700; letter-spacing:.2px; }
    .themeRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .themeChip{ flex:1 1 120px; display:flex; align-items:center; gap:10px; padding:10px; border-radius:12px; border:1px solid var(--border); cursor:pointer; }
    .swatch{ width:24px; height:24px; border-radius:7px; background:var(--accent); box-shadow:inset 0 0 0 2px rgba(0,0,0,.06); }

    /* Toast */
    .toast{ position:fixed; top:12px; right:12px; background:var(--warn-bg); border-left:4px solid var(--warn-border); padding:.7em 1em; border-radius:10px; color:#333; box-shadow:0 8px 22px rgba(0,0,0,.08); opacity:0; transform:translateY(-8px); transition:all .22s ease; max-width:420px; z-index:200; }
    .toast.show{ opacity:1; transform:translateY(0); }
  </style>
</head>
<body>
  <div class="wrap" id="app" aria-live="polite"></div>
  <div id="toast" class="toast" role="status" aria-live="polite">OK.</div>

  <!-- Theme popup modal -->
  <div id="themeModal" aria-hidden="true">
    <div class="bg"></div>
    <div class="panel" role="dialog" aria-modal="true" aria-label="Theme selector">
      <div class="head">
        <h2>Choose a color theme</h2>
        <button class="close" id="themeClose" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6 6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <select id="themeSelect">
        <option value="blue">Blue — calm</option>
        <option value="green">Green — fresh</option>
        <option value="pink">Pink — playful</option>
        <option value="sunset">Sunset — warm</option>
        <option value="slate">Slate — neutral</option>
        <option value="cyber">Cyber — dark</option>
      </select>
      <div class="themeRow" id="themeRow"></div>
    </div>
  </div>

  <script>
    (function(){
      // ---------- Theme ----------
      const COLOR_THEMES = [
        { id:'blue',   accent:'#0ea5e9' },
        { id:'green',  accent:'#22c55e' },
        { id:'pink',   accent:'#ec4899' },
        { id:'sunset', accent:'#fb923c' },
        { id:'slate',  accent:'#64748b' },
        { id:'cyber',  accent:'#38bdf8' }
      ];
      const THEME_STORAGE_KEY = 'camcookie_theme';
      const metaTheme = document.getElementById('meta-theme');

      function hexFromCssVar(name){
        const val = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        if (val.startsWith('#')) return val;
        const m = val.match(/rgba?\\((\\d+),\\s*(\\d+),\\s*(\\d+)/i);
        if (m){ const r=Number(m[1]).toString(16).padStart(2,'0'), g=Number(m[2]).toString(16).padStart(2,'0'), b=Number(m[3]).toString(16).padStart(2,'0'); return '#' + r + g + b; }
        return '#0ea5e9';
      }
      function applyTheme(name){
        const valid = COLOR_THEMES.map(t=>t.id);
        const next = valid.includes(name) ? name : 'blue';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem(THEME_STORAGE_KEY, next);
        metaTheme.setAttribute('content', hexFromCssVar('--accent'));
        const sel = document.getElementById('themeSelect'); if (sel) sel.value = next;
      }
      function loadTheme(){ applyTheme(localStorage.getItem(THEME_STORAGE_KEY) || 'blue'); }

      const themeModal = document.getElementById('themeModal');
      const themeClose = document.getElementById('themeClose');
      const themeSelect = document.getElementById('themeSelect');
      const themeRow = document.getElementById('themeRow');

      function toggleThemeModal(show){
        themeModal.classList.toggle('show', !!show);
        themeModal.setAttribute('aria-hidden', show ? 'false' : 'true');
      }
      themeClose.addEventListener('click', ()=> toggleThemeModal(false));
      themeModal.querySelector('.bg').addEventListener('click', ()=> toggleThemeModal(false));
      themeSelect.addEventListener('change', ()=> applyTheme(themeSelect.value));

      COLOR_THEMES.forEach(t=>{
        const chip = document.createElement('button');
        chip.className = 'themeChip';
        chip.innerHTML = '<span class="swatch"></span><span style="font-weight:700;text-transform:capitalize;">' + t.id + '</span>';
        chip.addEventListener('click', ()=> applyTheme(t.id));
        chip.style.setProperty('--accent', t.accent);
        themeRow.appendChild(chip);
      });

      document.addEventListener('keydown', (e)=>{
        // Conflict-free theme shortcut
        if (e.ctrlKey && e.altKey && e.code === 'KeyC'){ e.preventDefault(); toggleThemeModal(true); }
        if (e.code === 'Escape'){ toggleThemeModal(false); }
      });

      loadTheme();

      // ---------- Utilities ----------
      const app = document.getElementById('app');
      const toast = document.getElementById('toast');
      const qs = new URLSearchParams(location.search);

      const showToast = (msg, ms=1800)=>{
        toast.textContent = msg;
        toast.classList.add('show');
        clearTimeout(showToast._t);
        showToast._t = setTimeout(()=>toast.classList.remove('show'), ms);
      };
      const copyText = async (text)=>{ try{ await navigator.clipboard.writeText(text); showToast('Copied.'); }catch{ showToast('Copy failed.'); } };

      const todayDateOnly = ()=> new Date(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
      const dateOnlyFromParam = (yyyy_mm_dd)=> {
        if (!yyyy_mm_dd) return null;
        const [y,m,d] = yyyy_mm_dd.split('-').map(Number);
        if (!y||!m||!d) return null;
        return new Date(y, m-1, d);
      };
      const fmtDateLong = (yyyy_mm_dd)=>{
        if (!yyyy_mm_dd) return '—';
        const [y,m,d] = yyyy_mm_dd.split('-').map(Number);
        const dt = new Date(y, (m||1)-1, d||1);
        return dt.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
      };

      function parseItems(){
        const entries = qs.getAll('k');
        const items = [];
        for (const raw of entries){
          if (!raw) continue;
          const parts = String(raw).split('|');
          if (parts.length < 3) continue;
          try{
            const title = decodeURIComponent(parts[0] || '');
            const pin   = decodeURIComponent(parts[1] || '');
            const url   = decodeURIComponent(parts[2] || '');
            if (title || pin || url) items.push({ title, pin, url });
          }catch{}
        }
        return items;
      }

      function sanitizeUrl(raw){
        const trimmed = String(raw||'').trim();
        if (!trimmed) return '';
        const withProto = /^(https?:)?\\/\\//i.test(trimmed) ? trimmed : ('https://' + trimmed);
        try{
          const u = new URL(withProto);
          if (!/^https?$/i.test(u.protocol.replace(':',''))) return '';
          return u.toString();
        }catch{ return ''; }
      }

      // ---------- Views ----------
      function renderHeader({from, exp, count, expired}){
        const header = document.createElement('header');
        const left = document.createElement('div');
        const h1 = document.createElement('h1'); h1.textContent = 'Camcookie — MINI/view';
        left.appendChild(h1);
        const right = document.createElement('div'); right.className = 'actions';

        const src = document.createElement('span'); src.className = 'badge'; src.textContent = 'From: ' + (from || '—');
        const expBadge = document.createElement('span'); expBadge.className = 'badge ' + (expired ? 'warn' : '');
        expBadge.textContent = (expired ? 'Expired: ' : 'Expires: ') + fmtDateLong(exp||'—');
        const cnt = document.createElement('span'); cnt.className = 'badge'; cnt.textContent = (count||0) + ' item' + ((count||0)===1?'':'s');

        const themeBtn = document.createElement('button'); themeBtn.className = 'btn ghost'; themeBtn.textContent = 'Theme';
        themeBtn.title = 'Open theme selector (Ctrl+Alt+C)';
        themeBtn.addEventListener('click', ()=> toggleThemeModal(true));

        right.append(src, expBadge, cnt, themeBtn);
        header.append(left, right);
        return header;
      }

      function renderCards(items, expired){
        const grid = document.createElement('div'); grid.className = 'grid';
        items.forEach((it, i)=>{
          const card = document.createElement('div'); card.className = 'card';
          const title = document.createElement('div'); title.className = 'title'; title.textContent = it.title || ('Item ' + (i+1));

          const row1 = document.createElement('div'); row1.className = 'row';
          const pin = document.createElement('div'); pin.className = 'pin';
          pin.innerHTML = '<strong>PIN:</strong> <span>' + (String(it.pin||'—')) + '</span>';
          const copyPinBtn = document.createElement('button'); copyPinBtn.className = 'btn ghost'; copyPinBtn.textContent = 'Copy PIN';
          copyPinBtn.addEventListener('click', ()=> copyText(String(it.pin||'')));
          row1.append(pin, copyPinBtn);

          const row2 = document.createElement('div'); row2.className = 'row';
          const openBtn = document.createElement('button'); openBtn.className = 'btn'; openBtn.textContent = 'Open link';
          openBtn.addEventListener('click', ()=> { const u = sanitizeUrl(it.url); if (u) location.href = u; else showToast('Invalid link.'); });
          const copyLinkBtn = document.createElement('button'); copyLinkBtn.className = 'btn secondary'; copyLinkBtn.textContent = 'Copy link';
          copyLinkBtn.addEventListener('click', ()=> copyText(String(it.url||'')));
          const copyAllBtn = document.createElement('button'); copyAllBtn.className = 'btn ghost'; copyAllBtn.textContent = 'Copy title+PIN';
          copyAllBtn.addEventListener('click', ()=> copyText(`${it.title} — PIN: ${it.pin}`));

          if (!it.url) openBtn.disabled = true;
          if (expired) { openBtn.disabled = true; card.classList.add('expired'); }

          row2.append(openBtn, copyLinkBtn, copyAllBtn);

          const note = document.createElement('div'); note.className = 'muted small';
          try{ note.textContent = (new URL(it.url)).hostname; }catch{ note.textContent = '—'; }

          card.append(title, row1, row2, note);
          grid.appendChild(card);
        });
        return grid;
      }

      function renderExpiredNotice(exp){
        const n = document.createElement('div'); n.className = 'notice expired';
        n.textContent = `This collection expired on ${fmtDateLong(exp||'')}. You can still copy details, but links are disabled.`;
        return n;
      }

      function renderFooter({from, exp, count}){
        const f = document.createElement('div'); f.className = 'footer';
        const a = document.createElement('div'); a.textContent = 'Need to scan another code?';
        const toScan = document.createElement('button'); toScan.className = 'btn ghost'; toScan.textContent = 'Open scanner';
        toScan.addEventListener('click', ()=> renderScannerView(true));
        const meta = document.createElement('div'); meta.className = 'muted';
        meta.textContent = `From: ${from||'—'} • Expires: ${fmtDateLong(exp||'—')} • ${count||0} item${(count||0)===1?'':'s'}`;
        f.append(a, toScan, meta);
        return f;
      }

      function renderContentView(){
        const from = qs.get('from') || '';
        const expParam = qs.get('exp') || '';
        const items = parseItems();

        const expDateOnly = dateOnlyFromParam(expParam);
        let expired = false;
        if (expDateOnly){
          const today = todayDateOnly();
          expired = today.getTime() > expDateOnly.getTime();
        }

        app.innerHTML = '';
        app.appendChild(renderHeader({from, exp: expParam, count: items.length, expired}));
        if (expired) app.appendChild(renderExpiredNotice(expParam));
        if (!items.length){
          const empty = document.createElement('div'); empty.className = 'notice'; empty.textContent = 'No items were provided in the link.';
          app.appendChild(empty);
        } else {
          app.appendChild(renderCards(items, expired));
        }
        app.appendChild(renderFooter({from, exp: expParam, count: items.length}));
      }

      // ---------- Scanner ----------
      let mediaStream = null;
      let detector = null;
      let rafId = 0;

      async function ensureDetector(){
        if (!('BarcodeDetector' in window)) return null;
        try{
          const formats = await window.BarcodeDetector.getSupportedFormats?.() || [];
          if (formats.includes('qr_code')){
            return new window.BarcodeDetector({ formats: ['qr_code'] });
          }
          // Some impls accept lowercase/uppercase handling already
          return new window.BarcodeDetector({ formats: ['qr_code'] });
        }catch{
          try{ return new window.BarcodeDetector(); }catch{ return null; }
        }
      }

      async function startCamera(videoEl){
        // Prefer environment cam on mobile; default on desktop
        const constraints = { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }, audio:false };
        try{
          mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
          videoEl.srcObject = mediaStream;
          await videoEl.play();
          return true;
        }catch{
          return false;
        }
      }

      function stopCamera(){
        try{
          if (rafId) cancelAnimationFrame(rafId);
          rafId = 0;
          if (mediaStream){
            mediaStream.getTracks().forEach(t=>t.stop());
            mediaStream = null;
          }
        }catch{}
      }

      function scanLoop(videoEl, onFound){
        const tick = async ()=>{
          if (!detector || videoEl.readyState < 2){ rafId = requestAnimationFrame(tick); return; }
          try{
            const codes = await detector.detect(videoEl);
            if (codes && codes.length){
              const val = codes[0].rawValue || codes[0].rawValueText || '';
              if (val) { onFound(val); return; }
            }
          }catch{/* continue */}
          rafId = requestAnimationFrame(tick);
        };
        rafId = requestAnimationFrame(tick);
      }

      function renderScannerView(returnToContent=false){
        stopCamera();
        app.innerHTML = '';

        const header = document.createElement('header');
        const h1 = document.createElement('h1'); h1.textContent = 'Camcookie — MINI/view';
        const right = document.createElement('div'); right.className = 'actions';
        const hint = document.createElement('span'); hint.className = 'badge'; hint.textContent = 'Scan a QR code or paste a link';
        const themeBtn = document.createElement('button'); themeBtn.className = 'btn ghost'; themeBtn.textContent = 'Theme';
        themeBtn.addEventListener('click', ()=> toggleThemeModal(true));
        right.append(hint, themeBtn);
        header.append(h1, right);

        const wrap = document.createElement('div'); wrap.className = 'scanWrap';
        const box = document.createElement('div'); box.className = 'scanBox';

        const video = document.createElement('video'); video.id = 'cam'; video.playsInline = true; video.muted = true; video.autoplay = true; video.setAttribute('autoplay','');
        const stage = document.createElement('canvas'); stage.id = 'stage'; const ctx = stage.getContext('2d');

        const resBar = document.createElement('div'); resBar.className = 'row';
        const resText = document.createElement('div'); resText.className = 'muted small'; resText.style.wordBreak = 'break-all'; resText.style.flex = '1 1 auto';
        const openBtn = document.createElement('button'); openBtn.className = 'btn'; openBtn.textContent = 'Open link'; openBtn.disabled = true;
        const copyBtn = document.createElement('button'); copyBtn.className = 'btn secondary'; copyBtn.textContent = 'Copy link'; copyBtn.disabled = true;
        resBar.append(resText, copyBtn, openBtn);

        const controls = document.createElement('div'); controls.className = 'row';
        const backBtn = document.createElement('button'); backBtn.className = 'btn ghost'; backBtn.textContent = 'Back';
        backBtn.addEventListener('click', ()=> { stopCamera(); if (returnToContent) renderContentView(); else { history.replaceState(null, '', location.pathname); renderScannerView(false); }});
        const pasteBtn = document.createElement('button'); pasteBtn.className = 'btn ghost'; pasteBtn.textContent = 'Paste link';
        pasteBtn.addEventListener('click', async ()=>{
          try{
            const t = await navigator.clipboard.readText();
            if (t && /^https?:\\/\\//i.test(t)){ setResult(t, true); } else { showToast('Clipboard has no link.'); }
          }catch{ showToast('Clipboard blocked.'); }
        });

        const upload = document.createElement('input'); upload.type = 'file'; upload.accept = 'image/*'; upload.style.display = 'none';
        const uploadBtn = document.createElement('button'); uploadBtn.className = 'btn ghost'; uploadBtn.textContent = 'Upload image';
        uploadBtn.addEventListener('click', ()=> upload.click());
        upload.addEventListener('change', async ()=>{
          const file = upload.files?.[0]; if (!file) return;
          const img = new Image();
          img.onload = async ()=>{
            stage.width = img.naturalWidth; stage.height = img.naturalHeight;
            ctx.drawImage(img, 0, 0, stage.width, stage.height);
            try{
              if (!detector) detector = await ensureDetector();
              if (detector){
                const bmp = await createImageBitmap(img);
                const codes = await detector.detect(bmp);
                if (codes && codes[0]?.rawValue){ setResult(String(codes[0].rawValue), true); return; }
              }
              showToast('Could not read QR from image.');
            }catch{ showToast('Could not read QR from image.'); }
          };
          img.src = URL.createObjectURL(file);
        });

        const note = document.createElement('div'); note.className = 'hint small';
        note.textContent = 'Tip: In side panels, camera access may be restricted. Use Paste link or Upload image if needed.';

        controls.append(backBtn, pasteBtn, uploadBtn);

        box.append(video, stage, resBar, controls, note);
        wrap.append(box);
        app.append(header, wrap);

        let last = '';
        function setResult(text, fromUser=false){
          last = String(text||'');
          resText.textContent = last;
          const looksLink = /^https?:\\/\\//i.test(last);
          openBtn.disabled = !looksLink;
          copyBtn.disabled = !last;
          if (looksLink){
            try{
              const u = new URL(last);
              // Auto-open MINI/view links smoothly
              if (/\\/MINI\\/view\\/index\\.html$/i.test(u.pathname) && u.search) {
                showToast('Opening collection…');
                setTimeout(()=>{ location.href = last; }, 500);
              }
            }catch{}
          } else if (fromUser) {
            showToast('Not a link.');
          }
        }
        openBtn.addEventListener('click', ()=> { if (last) location.href = last; });
        copyBtn.addEventListener('click', ()=> { if (last) copyText(last); });

        // Start camera+detector if available
        ;(async ()=>{
          detector = await ensureDetector();
          if (!detector){
            // No live scan, but paste/upload still work
            video.replaceWith(document.createElement('div'));
            const fallback = document.createElement('div'); fallback.className = 'notice'; fallback.textContent = 'Live camera scanning is not supported here. Use Paste link or Upload image.';
            box.prepend(fallback);
            return;
          }
          const ok = await startCamera(video);
          if (!ok){
            video.replaceWith(document.createElement('div'));
            const fallback = document.createElement('div'); fallback.className = 'notice'; fallback.textContent = 'Camera permission unavailable. Use Paste link or Upload image.';
            box.prepend(fallback);
            return;
          }
          // Loop
          scanLoop(video, (val)=>{
            if (val && val !== last){
              setResult(val);
              showToast('QR detected.');
            }
          });
        })();
      }

      // ---------- Router ----------
      if (Array.from(qs.keys()).length > 0){
        renderContentView();
      } else {
        renderScannerView(false);
      }
    })();
  </script>
</body>
</html>